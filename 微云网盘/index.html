<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title>微云网页版</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
<div class="tipBox">
	<div class="tipTimeOut"><i></i>连接服务器超时，请稍后再试</div>
	<div class="tipDelSuccess"><i></i>删除文件成功</div>
	<div class="tipSelectFile"><i></i>请选择文件</div>
</div>
<div class="warnTip">
	<div class="tipDel">
		<h3>确定要删除这个文件夹吗？</h3>
		<p class="info">已删除的文件可以在回收站找到</p>
		<p class="btn">
			<a href="javascript:;">确定</a>
			<a href="javascript:;">取消</a>
		</p>
		<span></span>
	</div>
</div>
<div class="topInfo clear">
	<div class="left clear">
		<h1><a href=""><img src="images/logo.png">妙味云盘</a></h1>
		<span>妙味云盘</span>
	</div>
	<div class="right clear">
		<a href=""><img src="images/user.png"></a>
		<a href=""><img src="images/arrow.png"></a>
		<span></span>
		<a href=""><img src="images/set.png"></a>
	</div>
</div>
<div class="menuBox clear">
	<div class="left">
		<ul class="clear">
			<li><i></i><a href="javascript:;">下载</a></li>
			<li><i></i><a href="javascript:;">分享</a></li>
			<li><i></i><a href="javascript:;">移动到</a></li>
			<li><i></i><a href="javascript:;">重命名</a></li>
			<li><i></i><a href="javascript:;">删除</a></li>
			<li><i></i><a href="javascript:;">新建文件夹</a></li>
			<li><i></i><a href="javascript:;"></a></li>
		</ul>
	</div>
	<div class="right">
		<ul class="clear">
			<li><i></i><a href="javascript:;"></a></li>
			<li><i></i><a href="javascript:;"></a></li>
		</ul>
		<div class="select-list">
			<a href=""><i></i>按时间排序</a>
			<a href="" class="active"><i></i>按字母顺序</a>
			<a href=""><i></i>显示缩略图</a>
		</div>
	</div>

</div>
<div class="content">
	<div class="right">
		<div class="page-list clear">
			<div class="choose"></div>
			<div class="pages">
				<!-- <a href="javascript:;">微云<span></span></a>
				<a href="javascript:;">JS课程<span></span></a>
				<a href="javascript:;">CSS课程<span></span></a>
				<a href="javascript:;" class="active">JS基础课程<span></span></a> -->
			</div>
		</div>
		<div class="cont">
			<div class="bg-box">
				<div class="logo_bg"></div>
				<h4>暂无文件</h4>
				<p>请点击左上角的“上传”按钮添加</p>
			</div>
			<ul class="doc-list clear">
				<li>
					<a href="javascript:;" class="active">
						<span class="-doc-choose"></span>
						<strong>JS基础课程</strong>
					</a>
				</li>
				<!-- <li>
					<a href="javascript:;">
						<span></span>
						<strong>CSS课程</strong>
					</a>
				</li>
				<li class="type-1">
					<a href="javascript:;">
						<span></span>
						<strong>CSS3课程</strong>
					</a>
				</li>
				<li class="type-2">
					<a href="javascript:;">
						<span></span>
						<strong>未标题-2</strong>
					</a>
				</li>
				<li class="type-3">
					<a href="javascript:;">
						<span></span>
						<strong>要回复的帖子</strong>
					</a>
				</li>
				<li class="type-4">
					<a href="javascript:;">
						<span></span>
						<strong>8-12</strong>
					</a>
				</li> -->
			</ul>
			<ul class="doc-list-1ist">
				<li class="clear">
					<span class="doc-choose"></span>
					<strong>JS基础课程</strong>
					<div class="btn-list clear">
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
					</div>
					<i>2016-08-22&nbsp;&nbsp;&nbsp;&nbsp;16:08</i>
				</li>
				<li class="active clear">
					<span class="doc-choose doc-active"></span>
					<strong>JS基础课程</strong>
					<div class="btn-list clear">
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
					</div>
					<i>2016-08-22&nbsp;&nbsp;&nbsp;&nbsp;16:08</i>
				</li>
			</ul>
			<div class="scroll"></div>
		</div>
	</div>
	<div class="left">
		<!-- <ul class="list-1">
			<li>
				<a href="javascript:;" class="clear"><i></i><span class="doc-open">微云</span></a>
				<ul class="list-2">
					<li>
						<a href="javascript:;" class="clear"><i></i><span class="doc-open">JS课程</span></a>
						<ul class="list-3">
							<li class=" no-icon">
								<a href="javascript:;" class="clear"><span>123</span></a>
							</li>
							<li>
								<a href="javascript:;" class="clear"><i class="active"></i><span>333</span></a>
							</li>
							<li>
								<a href="javascript:;" class="clear"><i></i><span class="doc-open">CSS课程</span></a>
								<ul class="list-4">
									<li class=" no-icon">
										<a href="javascript:;" class="clear"><span>CSS课程</span></a>
									</li>
									<li class=" no-icon">
										<a href="javascript:;" class="clear"><span>123</span></a>
									</li>
									<li class=" no-icon">
										<a href="javascript:;" class="clear"><span>JS基础课程</span></a>
									</li>
								</ul>
							</li>
							<li class=" no-icon">
								<a href="javascript:;" class="clear"><span>11111</span></a>
							</li>
							<li class=" no-icon">
								<a href="javascript:;" class="clear"><span>11111</span></a>
							</li>
						</ul>
					</li>
				</ul>
			</li>
		</ul> -->
	</div>
</div>



<script src='js/data.js'></script>
<script src='js/index.js'></script>
<script>

/*------------ 操作数据的方法 ------------*/

//根据指定的id找到指定id的所有的子级
function getChildsById(id){
	var arr = [];
	for( var attr in data ){
		if( data[attr].pid == id ){
			arr.push(data[attr])
		}
	}
	return arr;
}

/*------------ 先渲染菜单区域 ------------*/

//先渲染第一层 先找数据
var leval = 0;
var initId = -1;//最顶层的父级

// 通过父级id找子级数据 pid
// 循环数据，那些数据的pid为 指定的id，就是指定id的子数据
function createTreeHtml(id,leval){
	//找到传过来参数id下所有的子级
	var arr = getChildsById(id);
	leval++;
	var treeHtml = '';
	if(arr.length){
		treeHtml += '<ul>';
		arr.forEach(function(item){
			// 如果没有下一级，createTreeHtml返回的结构为空
			var html = createTreeHtml(item.id,leval);
			treeHtml += `<li>
						<a data-id="${item.id}" href="javascript:;" class="clear" style="line-height:36px;padding-left:${leval*20}px;">${html !== '' ? '<i></i>' : '<i style="background:none;"></i>'}<span class="${html !== '' ? 'doc-open' : ''}">${item.title}</span></a>`
			// createTreeHtml返回的是下一级的结构
			treeHtml += html;
			treeHtml += '</li>';
		})
		treeHtml += '</ul>';
	}
	return treeHtml;
}

var left = document.querySelector('.content .left');

left.innerHTML = createTreeHtml(initId,leval);

/*------------ 定位到指定的元素 ------------*/

function positionElement (positionId){
	var treeAs = left.getElementsByTagName('a');
	for(var i = 0;i<treeAs.length;i++){
		// 给一个id，我给这个id对应的div添加样式
		if(treeAs[i].dataset.id == positionId){
			treeAs[i].classList.add('active');//添加active样式
			continue;
		}
		treeAs[i].classList.remove('active');
	}
}
positionElement(0);// 给指定id对应的元素添加class

/*------------ 文件区域 ------------*/
var bgBox = document.querySelector('.bg-box');
function createFileHtml (id){
	var childs = getChildsById(id);
	if(childs.length){
		bgBox.style.display = 'none';
		var filesHtml = childs.map(function(item){
			return `<li class='a' data-id="${item.id}">
						<a href="javascript:;" class="active">
							<span></span>
							<strong>${item.title}</strong>
						</a>
					</li>`
		}).join('');
	}else{
		//console.log(childs);
		bgBox.style.display = 'block';
		return null;
	}
	return filesHtml;
}

var docList = document.querySelector('.doc-list');
docList.innerHTML = createFileHtml(0);

/*------------ 渲染导航区域 ------------*/

// 找到指定id的父级的父级的父级的父级  找到最顶层的微云

// 找到指定id的祖先数据，一直找到最顶层
function getParentsById (id){
	var arr = [];
	for(var attr in data){
		if(data[attr].id == id){
			arr.push(data[attr]);
			// 传入父级的id，getParentsById返回是这个id的父级数据，
			// 使用concat把指定id的数据和父数据练级起来
			// 返回的是新数组，arr重新赋值这个新数组
			arr = arr.concat(getParentsById(data[attr].pid));
			break;
		}
	}
	return arr;
}

function creatNavHtml (id){
	var parents = getParentsById(id).reverse();
	var navHtml = '';
	for(var i = 0;i<parents.length-1;i++){
		navHtml += `<a data-id="${parents[i].id}" href="javascript:;">${parents[i].title}<span></span></a>`
	}
	navHtml += `<a data-id="${parents[i].id}" href="javascript:;" class="active" onclick="return false">${parents[i].title}</a>`
	return navHtml;
}
var navBar = document.querySelector('.pages');
navBar.innerHTML = creatNavHtml(0);

/*------------ 给树形菜单每个菜单绑定事件 ------------*/

var treeAs = left.getElementsByTagName('a');
for(var i = 0;i<treeAs.length;i++){
	treeAs[i].onclick = function(){
		var treeId = this.dataset.id;
		docList.innerHTML = createFileHtml(treeId);
		navBar.innerHTML = creatNavHtml(treeId);
		positionElement(treeId);
		clickNavA();
		clickFileLi();
	}
}

/*------------ 给导航中的每个元素绑定事件 ------------*/

clickNavA()
function clickNavA (){
	var navA = navBar.getElementsByTagName('a');

	for( var i = 0;i < navA.length;i++){
		navA[i].onclick = function (){
			var navAid = this.dataset.id;
			docList.innerHTML = createFileHtml(navAid);
			navBar.innerHTML = creatNavHtml(navAid);
			positionElement(navAid);
			clickNavA();
			clickFileLi()
		}
	}
}

/*------------ 给内容区的每个元素绑定事件 ------------*/

var chooseAll = document.querySelector('.choose');
clickFileLi()
function clickFileLi (){
	var fileLi = docList.getElementsByTagName('li');
	for( var i = 0;i < fileLi.length;i++){
		fileLi[i].onclick = function (ev){
			var fileLiId = this.dataset.id;
			if(ev.target.nodeName === 'SPAN'){
				return false;
			}
			docList.innerHTML = createFileHtml(fileLiId);
			navBar.innerHTML = creatNavHtml(fileLiId);
			positionElement(fileLiId);
			clickNavA();
			clickFileLi();
		}
	}
	chooseAll.classList.remove('chooseActive');
}

/*------------ 全选 ------------*/

function on(element,evName,fn){
	element.addEventListener(evName,fn);	
}
function off(element,evName,fn){
	element.removeEventListener(evName,fn);		
}

var spans = docList.getElementsByTagName('span');

var lis = docList.getElementsByTagName('li');

on(chooseAll,'click',function(){
	var bl = this.classList.toggle('chooseActive');
	if(bl){
		for(var i = 0;i < spans.length;i++){
			spans[i].classList.add('doc-choose');
			lis[i].classList.add('active');
		}
	}else{
		for(var i = 0;i < spans.length;i++){
			spans[i].classList.remove('doc-choose');
			lis[i].classList.remove('active');
		}
	}
})

/*------------ 单选 ------------*/

var spansChecked = docList.getElementsByClassName('doc-choose');
on(docList,'click',function(ev){
	if(ev.target.nodeName === 'SPAN'){
		var bl = ev.target.classList.toggle('doc-choose');
		if(bl){
			//ev.target.style.visibility = 'visible';
			ev.target.parentNode.parentNode.classList.add("active");
		}else{
			//ev.target.style.visibility = 'hidden';
			ev.target.parentNode.parentNode.classList.remove('active');
		}

		if(spansChecked.length === spans.length){
			chooseAll.classList.add('chooseActive');
		}else{
			chooseAll.classList.remove('chooseActive');
		}
		
	}
})

on(docList,'click',function(ev){
	var target = ev.target;
	if(target.classList.contains('doc-list')){
		return;
	}
	if(target === 'SPAN'){
		return;
	}
	if(target.parentNode.classList.contains('a')){
		target = target.parentNode;
	}
})




/*------------ 框选 ------------*/
var cont = document.querySelector('.cont')

for( var i = 0 ; i < spans.lenght ; i++ ){
	on(spans[i],'mousedown',function(ev){
		ev.stopPropagation();
		ev.preventDefault();
	})
}

on(cont,'mousedown',function(ev){
	ev.preventDefault();
	var newDiv = document.createElement("div");
	newDiv.className = 'newArea';
	

	var disX = ev.clientX;
	var disY = ev.clientY;
	newDiv.style.left = disX + 'px';
	newDiv.style.top = disY + 'px';

	//document.body.appendChild(newDiv);
	
	on(document,'mousemove',moveFn);
	on(document,'mouseup', upFn);

	function moveFn(ev){

		if(Math.abs(ev.clientX - disX > 10 || Math.abs(ev.clientY - disY) > 10) && !newDiv.isAppend){
			document.body.appendChild(newDiv);
			newDiv.isAppend = true;
		}

		newDiv.style.width = Math.abs(ev.clientX - disX) + 'px';
		newDiv.style.height = Math.abs(ev.clientY - disY) + 'px';
		newDiv.style.left = Math.min(ev.clientX,disX) + 'px';
		newDiv.style.top = Math.min(ev.clientY,disY) + 'px';

		for(var i = 0; i < lis.length; i++){
			if(collision(newDiv,lis[i])){
				lis[i].classList.add('active');
				//console.log(lis[i].children.firstElementChild)
				console.log(lis[i].firstElementChild.firstElementChild)
				lis[i].firstElementChild.firstElementChild.classList.add('doc-choose');
			}else{
				lis[i].classList.remove('active');
				lis[i].firstElementChild.firstElementChild.classList.remove('doc-choose');
			}
		}
		chooseAll.classList.remove('chooseActive');
	}
	function upFn(){
		off(document,'mousemove',moveFn);
		off(document,'mouseup',upFn);
		if(newDiv.isAppend){
			document.body.removeChild(newDiv);
		}
		
		
		var spansChecked = docList.getElementsByClassName('doc-choose');
		if(spansChecked.length === lis.length){
			chooseAll.classList.add('chooseActive');
		}else{
			chooseAll.classList.remove('chooseActive');
		}
	}

})

// 碰撞检测函数
function collision(obj1,obj2){
	var obj1Rect = obj1.getBoundingClientRect();	
	var obj2Rect = obj2.getBoundingClientRect();	

	if(obj1Rect.right < obj2Rect.left || obj1Rect.bottom < obj2Rect.top || obj1Rect.left > obj2Rect.right || obj1Rect.top > obj2Rect.bottom){
		return false;
	}else{
		return true;
	}
}






</script>
</body>
</html>
