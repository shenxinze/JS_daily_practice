<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title>微云网页版</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
<!-- tip -->
<div class="tipTimeOut"><i></i>连接服务器超时，请稍后再试</div>
<div class="tipSuccess"><i></i>删除文件成功</div>
<div class="tipSelectFile"><i></i>请选择文件</div>

<div class="warnTip">
	<div class="tipDel">
		<h3>确定要删除这个文件夹吗？</h3>
		<p class="info">已删除的文件可以在回收站找到</p>
		<p class="btn clear">
			<a href="javascript:;">确定</a>
			<a href="javascript:;">取消</a>
		</p>
		<span></span>
	</div>
</div>

<div class="topInfo clear">
	<div class="left clear">
		<h1><a href="javascript:;"><img src="images/logo.png">妙味云盘</a></h1>
		<span>妙味云盘</span>
	</div>
	<div class="right clear">
		<a href="javascript:;"><img src="images/user.png"></a>
		<a href="javascript:;"><img src="images/arrow.png"></a>
		<span></span>
		<a href="javascript:;"><img src="images/set.png"></a>
	</div>
</div>
<div class="menuBox clear">
	<div class="left">
		<ul class="clear">
			<li><i></i><a href="javascript:;">下载</a></li>
			<li><i></i><a href="javascript:;">分享</a></li>
			<li><i></i><a href="javascript:;">移动到</a></li>
			<li><i></i><a href="javascript:;">重命名</a></li>
			<li><i></i><a href="javascript:;">删除</a></li>
			<li><i></i><a href="javascript:;">新建文件夹</a></li>
			<li><i></i><a href="javascript:;"></a></li>
		</ul>
	</div>
	<div class="right">
		<ul class="clear">
			<li><i></i><a href="javascript:;"></a></li>
			<li><i></i><a href="javascript:;"></a></li>
		</ul>
		<div class="select-list">
			<a href="javascript:;"><i></i>按时间排序</a>
			<a href="javascript:;" class="active"><i></i>按字母顺序</a>
			<a href="javascript:;"><i></i>显示缩略图</a>
		</div>
	</div>

</div>
<div class="content">
	<div class="right">
		<div class="page-list clear">
			<div class="choose"></div>
			<div class="pages">
				<!-- <a href="javascript:;">微云<span></span></a>
				<a href="javascript:;">JS课程<span></span></a>
				<a href="javascript:;">CSS课程<span></span></a>
				<a href="javascript:;" class="active">JS基础课程<span></span></a> -->
			</div>
		</div>
		<div class="cont">
			<div class="bg-box">
				<div class="logo_bg"></div>
				<h4>暂无文件</h4>
				<p>请点击左上角的“上传”按钮添加</p>
			</div>
			<ul class="doc-list clear">
				<!--<li>
					<a href="javascript:;" class="active">
						<span class="-doc-choose"></span>
						<strong>JS基础课程</strong>
					</a>
				</li>
				 <li>
					<a href="javascript:;">
						<span></span>
						<strong>CSS课程</strong>
					</a>
				</li>
				<li class="type-1">
					<a href="javascript:;">
						<span></span>
						<strong>CSS3课程</strong>
					</a>
				</li>
				<li class="type-2">
					<a href="javascript:;">
						<span></span>
						<strong>未标题-2</strong>
					</a>
				</li>
				<li class="type-3">
					<a href="javascript:;">
						<span></span>
						<strong>要回复的帖子</strong>
					</a>
				</li>
				<li class="type-4">
					<a href="javascript:;">
						<span></span>
						<strong>8-12</strong>
					</a>
				</li> -->
			</ul>
			<ul class="doc-list-1ist">
				<li class="clear">
					<span class="doc-choose"></span>
					<strong>JS基础课程</strong>
					<div class="btn-list clear">
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
					</div>
					<i>2016-08-22&nbsp;&nbsp;&nbsp;&nbsp;16:08</i>
				</li>
				<li class="active clear">
					<span class="doc-choose doc-active"></span>
					<strong>JS基础课程</strong>
					<div class="btn-list clear">
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
						<a href="javascript:;"></a>
					</div>
					<i>2016-08-22&nbsp;&nbsp;&nbsp;&nbsp;16:08</i>
				</li>
			</ul>
			<div class="scroll"></div>
		</div>
	</div>
	<div class="left">
		<!-- <ul class="list-1">
			<li>
				<a href="javascript:;" class="clear"><i></i><span class="doc-open">微云</span></a>
				<ul class="list-2">
					<li>
						<a href="javascript:;" class="clear"><i></i><span class="doc-open">JS课程</span></a>
						<ul class="list-3">
							<li class=" no-icon">
								<a href="javascript:;" class="clear"><span>123</span></a>
							</li>
							<li>
								<a href="javascript:;" class="clear"><i class="active"></i><span>333</span></a>
							</li>
							<li>
								<a href="javascript:;" class="clear"><i></i><span class="doc-open">CSS课程</span></a>
								<ul class="list-4">
									<li class=" no-icon">
										<a href="javascript:;" class="clear"><span>CSS课程</span></a>
									</li>
									<li class=" no-icon">
										<a href="javascript:;" class="clear"><span>123</span></a>
									</li>
									<li class=" no-icon">
										<a href="javascript:;" class="clear"><span>JS基础课程</span></a>
									</li>
								</ul>
							</li>
							<li class=" no-icon">
								<a href="javascript:;" class="clear"><span>11111</span></a>
							</li>
							<li class=" no-icon">
								<a href="javascript:;" class="clear"><span>11111</span></a>
							</li>
						</ul>
					</li>
				</ul>
			</li>
		</ul> -->
	</div>
</div>
<script src='js/utils.js'></script>
<script src='js/data.js'></script>
<script src='js/index.js'></script>
<script>

/*------------ 操作数据的方法 ------------*/

//根据指定的id找到指定id的所有的子级
function getChildsById(id){
	var arr = [];
	for( var attr in data ){
		if( data[attr].pid == id ){
			arr.push(data[attr])
		}
	}
	return arr;
}

// 通过id找数据
function getDataById(id){
	var item = data[id];
	if(item){
		return item
	}
	return null;
}

/*------------ 先渲染菜单区域 ------------*/

//先渲染第一层 先找数据
var leval = 0;
var initId = -1;//最顶层的父级

// 通过父级id找子级数据 pid
// 循环数据，那些数据的pid为 指定的id，就是指定id的子数据
function createTreeHtml(id,leval){
	//找到传过来参数id下所有的子级
	var arr = getChildsById(id);
	leval++;
	var treeHtml = '';
	if(arr.length){
		treeHtml += '<ul>';
		arr.forEach(function(item){
			// 如果没有下一级，createTreeHtml返回的结构为空
			var html = createTreeHtml(item.id,leval);
			treeHtml += `<li>
						<a data-id="${item.id}" href="javascript:;" class="clear" style="line-height:36px;padding-left:${leval*20}px;">${html !== '' ? '<i></i>' : '<i style="background:none;"></i>'}<span class="${html !== '' ? 'doc-open' : ''}">${item.title}</span></a>`
			// createTreeHtml返回的是下一级的结构
			treeHtml += html;
			treeHtml += '</li>';
		})
		treeHtml += '</ul>';
	}
	return treeHtml;
}

var left = document.querySelector('.content .left');

left.innerHTML = createTreeHtml(initId,leval);

/*------------ 定位到指定的元素 ------------*/

function positionElement (positionId){
	var treeAs = left.getElementsByTagName('a');
	for(var i = 0;i<treeAs.length;i++){
		// 给一个id，我给这个id对应的div添加样式
		if(treeAs[i].dataset.id == positionId){
			treeAs[i].classList.add('active');//添加active样式
			continue;
		}
		treeAs[i].classList.remove('active');
	}
}
positionElement(0);// 给指定id对应的元素添加class

/*------------ 文件区域 ------------*/
var bgBox = document.querySelector('.bg-box');
function createFileHtml (id){
	var childs = getChildsById(id);
	if(childs.length){
		bgBox.style.display = 'none';
		var filesHtml = childs.map(function(item){
			return `<li class='a' data-id="${item.id}">
						<a href="javascript:;" class="active">
							<span></span>
							<input type="text" value='${item.title}' />
						</a>
					</li>`
		}).join('');
	}else{
		bgBox.style.display = 'block';
		return null;
	}
	return filesHtml;
}

var docList = document.querySelector('.doc-list');
docList.innerHTML = createFileHtml(0);

/*------------ 渲染导航区域 ------------*/

// 找到指定id的父级的父级的父级的父级  找到最顶层的微云

// 找到指定id的祖先数据，一直找到最顶层
function getParentsById (id){
	var arr = [];
	for(var attr in data){
		if(data[attr].id == id){
			arr.push(data[attr]);
			// 传入父级的id，getParentsById返回是这个id的父级数据，
			// 使用concat把指定id的数据和父数据练级起来
			// 返回的是新数组，arr重新赋值这个新数组
			arr = arr.concat(getParentsById(data[attr].pid));
			break;
		}
	}
	return arr;
}

function creatNavHtml (id){
	var parents = getParentsById(id).reverse();
	var navHtml = '';
	for(var i = 0;i<parents.length-1;i++){
		navHtml += `<a data-id="${parents[i].id}" href="javascript:;">${parents[i].title}<span></span></a>`
	}
	navHtml += `<a data-id="${parents[i].id}" href="javascript:;" class="active" onclick="return false">${parents[i].title}</a>`
	return navHtml;
}
var navBar = document.querySelector('.pages');
navBar.innerHTML = creatNavHtml(0);

/*------------ 给树形菜单每个菜单绑定事件 ------------*/

clickTree()
function clickTree(){
	var treeAs = left.getElementsByTagName('a');
	for(var i = 0;i<treeAs.length;i++){
		treeAs[i].onclick = function(){
			var treeId = this.dataset.id;
			docList.innerHTML = createFileHtml(treeId);
			navBar.innerHTML = creatNavHtml(treeId);
			positionElement(treeId);
			clickNavA();
			clickFileLi();
		}
	}
}
/*------------ 给导航中的每个元素绑定事件 ------------*/

clickNavA()
function clickNavA (){
	var navA = navBar.getElementsByTagName('a');

	for( var i = 0;i < navA.length;i++){
		navA[i].onclick = function (){
			var navAid = this.dataset.id;
			docList.innerHTML = createFileHtml(navAid);
			navBar.innerHTML = creatNavHtml(navAid);
			positionElement(navAid);
			clickNavA();
			clickFileLi()
		}
	}
}

/*------------ 给内容区的每个元素绑定事件 ------------*/

var chooseAll = document.querySelector('.choose');
clickFileLi()
function clickFileLi (){
	var fileLi = docList.getElementsByTagName('li');
	for( var i = 0;i < fileLi.length;i++){
		fileLi[i].onclick = function (ev){
			var fileLiId = this.dataset.id;
			if(ev.target.nodeName === 'SPAN'){
				return false;
			}
			docList.innerHTML = createFileHtml(fileLiId);
			navBar.innerHTML = creatNavHtml(fileLiId);
			positionElement(fileLiId);
			clickNavA();
			clickFileLi();
		}
	}
	chooseAll.classList.remove('chooseActive');
}

/*------------ 全选 ------------*/

function on(element,evName,fn){
	element.addEventListener(evName,fn);	
}
function off(element,evName,fn){
	element.removeEventListener(evName,fn);		
}

var spans = docList.getElementsByTagName('span');

var lis = docList.getElementsByTagName('li');

on(chooseAll,'click',function(){
	var bl = this.classList.toggle('chooseActive');
	if( lis.length === 0){
		this.classList.remove('chooseActive');
	}
	if(bl){
		for(var i = 0;i < spans.length;i++){
			spans[i].classList.add('doc-choose');
			lis[i].classList.add('active');
		}
	}else{
		for(var i = 0;i < spans.length;i++){
			spans[i].classList.remove('doc-choose');
			lis[i].classList.remove('active');
		}
	}
})

/*------------ 单选 ------------*/

var spansChecked = docList.getElementsByClassName('doc-choose');
on(docList,'click',function(ev){
	if(ev.target.nodeName === 'SPAN'){
		var bl = ev.target.classList.toggle('doc-choose');
		if(bl){
			//ev.target.style.visibility = 'visible';
			ev.target.parentNode.parentNode.classList.add("active");
		}else{
			//ev.target.style.visibility = 'hidden';
			ev.target.parentNode.parentNode.classList.remove('active');
		}

		if(spansChecked.length === spans.length){
			chooseAll.classList.add('chooseActive');
		}else{
			chooseAll.classList.remove('chooseActive');
		}
		
	}
})

on(docList,'click',function(ev){
	var target = ev.target;
	if(target.classList.contains('doc-list')){
		return;
	}
	if(target === 'SPAN'){
		return;
	}
	if(target.parentNode.classList.contains('a')){
		target = target.parentNode;
	}
})




/*------------ 框选 ------------*/

var cont = document.querySelector('.cont')

/*for( var i = 0 ; i < spans.lenght ; i++ ){
	on(spans[i],'mousedown',function(ev){
		ev.stopPropagation();
		ev.preventDefault();
	})
}
*/
on(cont,'mousedown',function(ev){
	//ev.preventDefault();
	if(lis.length === 0){
		return;
	}
	var newDiv = document.createElement("div");
	newDiv.className = 'newArea';
	

	var disX = ev.clientX;
	var disY = ev.clientY;
	newDiv.style.left = disX + 'px';
	newDiv.style.top = disY + 'px';

	//document.body.appendChild(newDiv);
	
	on(document,'mousemove',moveFn);
	on(document,'mouseup', upFn);

	function moveFn(ev){

		if(Math.abs(ev.clientX - disX > 10 || Math.abs(ev.clientY - disY) > 10)){
			if(!newDiv.isAppend){
				document.body.appendChild(newDiv);
				newDiv.isAppend = true;
			}
		}

		newDiv.style.width = Math.abs(ev.clientX - disX) + 'px';
		newDiv.style.height = Math.abs(ev.clientY - disY) + 'px';
		newDiv.style.left = Math.min(ev.clientX,disX) + 'px';
		newDiv.style.top = Math.min(ev.clientY,disY) + 'px';

		for(var i = 0; i < lis.length; i++){
			if(collision(newDiv,lis[i])){
				lis[i].classList.add('active');
				lis[i].firstElementChild.firstElementChild.classList.add('doc-choose');
			}else{
				lis[i].classList.remove('active');
				lis[i].firstElementChild.firstElementChild.classList.remove('doc-choose');
			}
		}
		chooseAll.classList.remove('chooseActive');
	}
	function upFn(){
		off(document,'mousemove',moveFn);
		off(document,'mouseup',upFn);
		if(newDiv.isAppend){
			document.body.removeChild(newDiv);
		}
		
		var spansChecked = docList.getElementsByClassName('doc-choose');
		if(lis.length && spansChecked.length === lis.length){
			chooseAll.classList.add('chooseActive');
		}else{
			chooseAll.classList.remove('chooseActive');
		}
	}

})

// 碰撞检测函数
function collision(obj1,obj2){
	var obj1Rect = obj1.getBoundingClientRect();	
	var obj2Rect = obj2.getBoundingClientRect();	

	if(obj1Rect.right < obj2Rect.left || obj1Rect.bottom < obj2Rect.top || obj1Rect.left > obj2Rect.right || obj1Rect.top > obj2Rect.bottom){
		return false;
	}else{
		return true;
	}
}

/*------------ 新建文件夹 ------------*/
/*
	创建文件夹：
		1.点击创建文件夹，生成一个新的结构；
			1> 获得焦点，输入文件名称，点击其他地方失去焦点
				1> 文件名与兄弟文件夹名不一样，点击其他地方失去焦点，创建a成功；
				2> 文件名与兄弟文件夹有重名，创建不成功；
				3> 文件夹名称为空，创建不成功

*/
var newFile = document.querySelector('.left li:nth-child(6)');

on(newFile,'mouseup',function(ev){
	var newLi = document.createElement('li');
	newLi.className = 'a';
	newLi.innerHTML = `
		<a href="javascript:;" class="active">
			<span></span>
			<input type="text" value='' />
		 </a>`;
	var firstNode = docList.querySelector('li:nth-child(1)');
	ev.stopPropagation();
	if(docList.children){
		bgBox.style.display = 'none';
	}
	docList.insertBefore(newLi,firstNode);
	var input = newLi.getElementsByTagName('input');
	input[0].focus();
	input[0].style.borderColor = '#55addc';

	newFile.isCreateing = true;
})

on(document,'mousedown',function(){
	if(newFile.isCreateing){
		var newLi = docList.firstElementChild;
		var newInput = newLi.getElementsByTagName('input')[0];
		newInput.style.borderColor = 'transparent';

		var tValue = newInput.value;
		
		if(tValue == ''){
			newLi.remove();
			if(!spans.length){
				//console.log('我在这里')
				bgBox.style.display = 'block';
			}

		}else{
			var isExistName = false;
			var id = navBar.lastElementChild.dataset.id;//当前id
			var childs = getChildsById(id);//当前id下所有的子集
			for(var i = 0;i < childs.length;i++){
				if(childs[i].title === tValue){
					isExistName = true;
					break;
				}
			}
			if(isExistName){
				newLi.remove();
			}else{
				//创建成功提示动画
				var tipSuccess = document.querySelector('.tipSuccess');
				tipSuccess.innerHTML = '<i></i>创建文件成功';
				mTween(tipSuccess,{
	                top: 15,
	                opacity:1
	            },200,'linear',function(){
	            	setTimeout(function(){
	            		mTween(tipSuccess,{
	            			opacity:0,
	            			top:-55
	            		},400)
	            	},600)
	            })
	            var pid = navBar.lastElementChild.dataset.id;
				var id = Date.now();
				
				data[id] = {
					"id": id,
		       		"pid": pid,
		        	"title": tValue
				}
			
				var newLi = newInput.parentNode.parentNode;

				newLi.setAttribute('data-id',id);

				clickNavA();
				clickFileLi()
				left.innerHTML = createTreeHtml(initId,leval);
				positionElement(id);
				clickTree();
			}
		}
	

		newFile.isCreateing = false;
		//var tValue = docList.querySelector('.doc-list li:nth-child(1) input').value;
		
	}
})

/*------------ 删除文件夹 ------------*/

var delFile = document.querySelector('.left li:nth-child(5)');
var warnTip = document.querySelector('.warnTip');
var tipDel = document.querySelector('.tipDel');
var btnSure = document.querySelector('.btn a:nth-child(1)');
var btnClose = document.querySelector('.btn a:nth-child(2)');
var closeTip = document.querySelector('.warnTip span');
var tipSelectFile = document.querySelector('.tipSelectFile');
//点击菜单中的删除按钮
on(delFile,'click',function(){

	if(spansChecked.length == 0){
		tipSelectFile.innerHTML = '<i></i>请选择文件';
		mTween(tipSelectFile,{
            top: 15,
            opacity:1
        },200,'linear',function(){
        	setTimeout(function(){
        		mTween(tipSelectFile,{
        			opacity:0,
        			top:-55
        		},400)
        	},600)
        })
	}else{
		warnTip.style.display = 'block';
	}
});

//获取选中的span
/*function whoSelected(){
	var arr = [];
	for(var i = 0;i < spans.length;i++ ){
		if(spans[i].className == 'doc-choose'){
			arr.push(spans[i]);
		}
		return arr;
	}
}*/

//提示框 - 确定删除按钮
on(btnSure,'click',function(){
	var selectArr = [];
	for(var i = 0;i < spans.length;i++){
		if(spans[i].classList.contains('doc-choose')){
			selectArr.push(spans[i]);
		}
	}
	// 找到指定id下所有的子孙数据
	function getChildsAllById(id){
		// 找到这个id的数据
		var item = getDataById(id);
		var arr = [];
		// 把id对对应的数据push到数组中
		arr.push(item);
		for(var attr in data){
			if(data[attr].pid == id){
				arr = arr.concat(getChildsAllById(data[attr].id))
			}
		}
		return arr;
	}

	// 删除指定id下所有的子孙数据
	function delectDataById(id){
		var childsAll = getChildsAllById(id);
		for( var i = 0; i < childsAll.length; i++ ){
			delete data[childsAll[i].id]
		}
	}

	for(var i = 0;i < selectArr.length;i++){
		console.log(selectArr[i].parentNode.parentNode);
		selectArr[i].parentNode.parentNode.remove();
		delectDataById(selectArr[i].parentNode.parentNode.dataset.id);
	}
	if(lis.length === 0){
		bgBox.style.display = 'block';
		chooseAll.classList.remove('chooseActive');
	}

	warnTip.style.display = 'none';

	left.innerHTML = createTreeHtml(initId,leval);
	var id = navBar.lastElementChild.dataset.id;
	positionElement(id);
	clickTree();
});

//提示框 - 取消删除按钮
on(btnClose,'click',function(){
	warnTip.style.display = 'none';
	/*for(var i = 0; i < lis.length;i++){
		spans[i].className = '';
		lis[i].classList.remove('active');
	}
	chooseAll.classList.remove('chooseActive');*/
});

on(closeTip,'click',function(){
	warnTip.style.display = 'none';
})

//拖拽移动
/*on(tipDel,'mousedown',function(ev){
	var disX = ev.clientX - tipDel.offsetLeft;
	var disY = ev.clientY - tipDel.offsetTop;

	var maxX = document.documentElement.clientX - tipDel.clientWidth;
	var maxY = document.documentElement.clientY - tipDel.clientHeight;

	on(document,'mousemove',function(ev){
		tipDel.style.cursor = 'move';
		var w = ev.clientX - disX + tipDel.clientWidth/2;
		var h = ev.clientY - disY + tipDel.clientHeight/2;

		if( w < 0 ){
			w = 0;
		}
		if( h < 0 ){
			h = 0;
		}
		if( w > maxX ){
			w = maxX;
		}
		if( h > maxY ){
			h = maxY;
		}

		tipDel.style.left = w + 'px';
		tipDel.style.top = h + 'px';
	})

	on(document,'mouseup',function(){
		
	})

})*/


/*------------ 重命名 ------------*/

var reName = document.querySelector('.left li:nth-child(4)');
var state = false;
var oldValue = '';
var newValue = '';
on(reName,'click',function(ev){
	if(spansChecked.length === 0){
		tipSelectFile.innerHTML = '<i></i>请选择文件';
		mTween(tipSelectFile,{
            top: 15,
            opacity:1
        },200,'linear',function(){
        	setTimeout(function(){
        		mTween(tipSelectFile,{
        			opacity:0,
        			top:-55
        		},400)
        	},600)
        })
	}else{
		if(spansChecked.length === 1){
			for(var i = 0;i < spans.length;i++){
				if(spans[i].classList.contains('doc-choose')){
					var input = spans[i].parentNode.querySelector('input');
					
					input.focus();
					input.select();
					oldValue = input.value;
					input.style.borderColor = '#55addc';
				}
			}
			
			state = true;
		}else{
			tipSelectFile.innerHTML = '<i></i>每次只能重新命名一个文件夹';
			mTween(tipSelectFile,{
	            top: 15,
	            opacity:1
	        },200,'linear',function(){
	        	setTimeout(function(){
	        		mTween(tipSelectFile,{
	        			opacity:0,
	        			top:-55
	        		},400)
	        	},600)
	        })
		}

	}
})
on(document,'mouseup',function(){
	var inputs = docList.getElementsByTagName('input');
	if(state){
		var isExistName = false;
		var id = navBar.lastElementChild.dataset.id;//当前id
		var childs = getChildsById(id);//当前id下所有的子集
		for(var i = 0;i < childs.length;i++){
			if(childs[i].title === newValue){
				isExistName = true;
				break;
			}
		}

		//命名文件夹重名提示
		if(isExistName){
			tipSelectFile.innerHTML = '<i></i>文件夹有重名，不能命名';
			console.log(newValue,oldValue)
			newValue = oldValue;
			mTween(tipSelectFile,{
	            top: 15,
	            opacity:1
	        },200,'linear',function(){
	        	setTimeout(function(){
	        		mTween(tipSelectFile,{
	        			opacity:0,
	        			top:-55
	        		},400)
	        	},600)
	        })
		}

		for(var i = 0;i < inputs.length;i++){
			inputs[i].style.borderColor = 'transparent';
			inputs[i].parentNode.parentNode.classList.remove('active');
			spans[i].classList.remove('doc-choose');
		}
	}
	state = false;
})
</script>
</body>
</html>
